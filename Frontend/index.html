<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Jukebox</title>
    <style>
      :root {
        color-scheme: dark;
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        --bg: #0c0c0f;
        --card: #181820;
        --accent: #1db954;
        --muted: #9ca3af;
        --border: #252531;
        --text: #fff;
      }

      body.theme-blues {
        font-family: 'Special Elite', 'Times New Roman', serif;
        --bg: #1b1410;
        --card: #2b1f16;
        --accent: #f4c26b;
        --muted: #d6bfa7;
        --border: #4c2c1c;
        --text: #fdf5e6;
        --glow-color: rgba(244, 194, 107, 0.25);
        background-image:
          radial-gradient(circle at 15% 20%, rgba(244,194,107,0.25), transparent 40%),
          linear-gradient(120deg, rgba(44,27,19,0.85), rgba(14,8,6,0.95));
      }

      body {
        margin: 0;
        background: radial-gradient(circle at top, #181820, #050507 60%);
        color: var(--text);
        min-height: 100vh;
        transition: background 0.4s ease;
        position: relative;
        --glow-color: rgba(29, 185, 84, 0.25);
      }

      body::before {
        content: '';
        position: fixed;
        inset: 0;
        pointer-events: none;
        background: radial-gradient(circle at var(--glow-x, 50%) var(--glow-y, 30%), var(--glow-color, rgba(29, 185, 84, 0.25)), transparent 45%);
        transition: background 0.15s ease;
        z-index: -1;
      }

      .page {
        max-width: 960px;
        margin: 0 auto;
        padding: 32px 20px 64px;
        display: flex;
        flex-direction: column;
        gap: 32px;
      }

      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
      }

      header p {
        margin: 0;
        color: var(--muted);
      }

      h1 {
        font-size: 2rem;
        margin: 8px 0 0;
      }

      .theme-toggle {
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 10px 18px;
        background: var(--card);
        color: var(--text);
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.1s ease, border-color 0.1s ease;
      }

      .theme-toggle:hover {
        transform: translateY(-1px);
        border-color: var(--accent);
      }

      .section {
        background: rgba(0,0,0,0.2);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 24px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        background-color: var(--card);
      }

      .section h2 {
        margin-top: 0;
        font-size: 1.3rem;
      }

      .now-playing {
        display: flex;
        gap: 24px;
        align-items: center;
      }

      .now-playing__info {
        flex: 1;
      }

      .now-playing__track {
        font-size: 1.1rem;
        margin: 0;
      }
      .now-playing__artwrap {
        width: 160px;
        height: 160px;
        margin-top: 14px;
        display: none;
      }
      .vinyl-disc {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background-image: url('https://gallery.yopriceville.com/var/resizes/Free-Clipart-Pictures/Music-PNG/Gramophone_Vinyl_LP_Record_PNG_Transparent_Clip_Art_Image.png?m=1462983196');
        background-size: 110% 110%;
        background-position: center;
        box-shadow: 0 0 20px rgba(0,0,0,0.45);
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .vinyl-disc::before {
        content: '';
        position: absolute;
        inset: 8%;
        border-radius: 50%;
        border: 2px solid rgba(255,255,255,0.12);
        mix-blend-mode: screen;
      }
      .vinyl-disc--spinning {
        animation: spinThat 5s linear infinite;
      }
      .now-playing__art {
        width: 40%;
        height: 40%;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid rgba(0,0,0,0.7);
        box-shadow: inset 0 0 6px rgba(0,0,0,0.6);
        position: relative;
        z-index: 2;
      }
      @keyframes spinThat {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      .muted {
        color: var(--muted);
        margin: 4px 0 0;
      }

      .controls {
        display: flex;
        gap: 12px;
      }

      .btn {
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 10px 18px;
        background: var(--card);
        color: inherit;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.1s ease, border-color 0.1s ease;
      }

      .btn:hover {
        transform: translateY(-1px);
        border-color: var(--accent);
      }

      .btn--accent {
        background: var(--accent);
        color: #000;
        border-color: var(--accent);
      }

      body.theme-blues .btn--accent {
        color: #1b1410;
      }

      .sparkle-btn {
        --sparkle-color: #000;
        --sparkle-shadow: rgba(0, 0, 0, 0.35);
        --sparkle-glare: hsla(0, 0%, 100%, 0.8);
        --sparkle-hover: 0.4;
        --sparkle-pos: 0;
        position: relative;
        overflow: hidden;
        color: transparent;
        padding: 12px 22px;
      }

      .sparkle-btn:hover {
        --sparkle-hover: 1;
        --sparkle-pos: 1;
      }

      .sparkle-btn:active {
        --sparkle-hover: 0;
      }

      .sparkle-label {
        display: inline-block;
        font-size: 1rem;
        font-weight: 600;
        text-decoration: none;
        text-shadow:
          calc(var(--sparkle-hover) * -0px) calc(var(--sparkle-hover) * 0px) var(--sparkle-shadow),
          calc(var(--sparkle-hover) * -1px) calc(var(--sparkle-hover) * 1px) var(--sparkle-shadow),
          calc(var(--sparkle-hover) * -2px) calc(var(--sparkle-hover) * 2px) var(--sparkle-shadow);
        transform: translate(
          calc(var(--sparkle-hover) * 2px),
          calc(var(--sparkle-hover) * -2px)
        );
      }

      .sparkle-label:last-of-type {
        position: absolute;
        inset: 0;
        padding: 12px 22px;
        background: linear-gradient(
          120deg,
          transparent 0 55%,
          var(--sparkle-glare) 55% 60%,
          transparent 60% 70%,
          var(--sparkle-glare) 70% 85%,
          transparent 85%
        ) calc(var(--sparkle-pos) * -200%) 0 / 200% 100%, var(--sparkle-color);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        text-shadow: none;
      }

      .sparkle-btn svg {
        position: absolute;
        width: 16px;
        aspect-ratio: 1;
        fill: var(--sparkle-glare);
        top: calc(var(--y, 50) * 1%);
        left: calc(var(--x, 0) * 1%);
        transform: translate(-50%, -50%) scale(0);
        pointer-events: none;
      }

      .sparkle-btn svg:nth-of-type(1) { --x: 5; --y: 20; --s: 1.3; --d: 0.1; }
      .sparkle-btn svg:nth-of-type(2) { --x: 15; --y: 80; --s: 1.2; --d: 0.25; }
      .sparkle-btn svg:nth-of-type(3) { --x: 45; --y: 40; --s: 1.1; --d: 0.4; }
      .sparkle-btn svg:nth-of-type(4) { --x: 75; --y: 60; --s: 1; --d: 0.55; }
      .sparkle-btn svg:nth-of-type(5) { --x: 95; --y: 25; --s: 0.9; --d: 0.7; }

      .sparkle-btn:hover svg {
        animation: sparkle 0.75s calc(var(--d) * 0.2s) both;
      }

      @keyframes sparkle {
        0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
        50% { transform: translate(-50%, -50%) scale(var(--s, 1)); opacity: 1; }
        100% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
      }

      .card {
        background: var(--card);
        border-radius: 16px;
        padding: 18px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        border: 1px solid transparent;
        transition: border-color 0.1s ease, transform 0.15s ease;
      }

      .card:hover {
        border-color: var(--accent);
        transform: translateY(-2px);
      }

      .playlist-cover {
        width: 100%;
        aspect-ratio: 1;
        border-radius: 12px;
        object-fit: cover;
        background: #333;
      }

      body.theme-blues .playlist-cover {
        filter: sepia(60%) contrast(1.05) saturate(0.8);
      }

      .search-area {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      #q {
        width: 95%;
        border-radius: 999px;
        padding: 14px 18px;
        border: 1px solid var(--border);
        background: #101019;
        color: #fff;
        font-size: 1rem;
      }

      body.theme-blues #q {
        background: rgba(0,0,0,0.3);
        color: var(--text);
        border-color: var(--border);
      }

      #results {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      #results li {
        background: var(--card);
        border-radius: 12px;
        padding: 12px;
        border: 1px solid transparent;
      }

      #results li:hover {
        border-color: var(--accent);
      }

      .result-btn {
        background: none;
        border: none;
        color: inherit;
        width: 100%;
        text-align: left;
        cursor: pointer;
      }

      .toast {
        text-align: center;
        min-height: 18px;
        color: var(--accent);
      }

      @media (max-width: 600px) {
        .now-playing {
          flex-direction: column;
          align-items: flex-start;
        }
        .top-bar {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
  </head>
  <body class="theme-modern">
    <div class="page">
      <div class="top-bar">
        <header>
          <p class="muted">IRL Jukebox</p>
          <h1>Pick a playlist, queue a song, keep the vibe going.</h1>
        </header>
        <button class="theme-toggle" id="theme-toggle">Switch to Vintage</button>
      </div>

      <section class="section now-playing">
        <div class="now-playing__info">
          <p class="muted" id="device">Waiting for player…</p>
          <p class="now-playing__track" id="track">Nothing playing</p>
          <div class="now-playing__artwrap" id="art-wrap">
            <div class="vinyl-disc" id="vinyl-disc">
              <img id="track-art" class="now-playing__art" alt="Album art">
            </div>
          </div>
          <p class="muted" id="progress"></p>
        </div>
        <div class="controls">
          <button class="btn" data-control="previous">Prev</button>
          <button class="btn btn--accent" data-control="play">Play</button>
          <button class="btn" data-control="pause">Pause</button>
          <button class="btn" data-control="next">Next</button>
        </div>
      </section>

      <section class="section">
        <div class="section-header">
          <h2>Featured Playlists</h2>
          <p class="muted">Presets we can always lean on.</p>
        </div>
        <div class="grid" id="playlist-grid"></div>
      </section>

      <section class="section search-area">
        <div>
          <h2>Search the catalog</h2>
          <p class="muted">Type anything Spotify knows about and add it to the queue.</p>
        </div>
        <input id="q" placeholder="Type a song name">
        <ul id="results"></ul>
        <div class="toast" id="toast"></div>
      </section>
    </div>

    <script>
      const q = document.getElementById('q');
      const ul = document.getElementById('results');
      const toast = document.getElementById('toast');
      const playlistGrid = document.getElementById('playlist-grid');
      const trackEl = document.getElementById('track');
      const deviceEl = document.getElementById('device');
      const progressEl = document.getElementById('progress');
      const artEl = document.getElementById('track-art');
      const artWrap = document.getElementById('art-wrap');
      const vinylDisc = document.getElementById('vinyl-disc');
      const controlButtons = document.querySelectorAll('[data-control]');
      const themeToggle = document.getElementById('theme-toggle');
      let timer;

      const playlists = [
        { name: 'Obsession', desc: 'A little bit of this... A little bit of that...', cover: 'https://image-cdn-fa.spotifycdn.com/image/ab67706c0000da849318af96125a5ba045e7c346', playlistUri: 'spotify:playlist:1LNq2XdOR7uwI5QUF0R1PD' },
        { name: 'Rainy Night', desc: 'Take a beat with this playlist.', cover: 'https://mosaic.scdn.co/640/ab67616d00001e02291c9ace63ec929a08d91699ab67616d00001e024fb043195e8d07e72edc7226ab67616d00001e02e4ca61044bed05034bfef216ab67616d00001e02ed801e58a9ababdea6ac7ce4', playlistUri: 'spotify:playlist:6trooOM8TetI8UfCtw6cNH' }
      ];

      const showToast = (msg, color = 'var(--accent)') => {
        toast.style.color = color;
        toast.textContent = msg;
        setTimeout(() => { toast.textContent = ''; }, 3500);
      };

      const queueTrack = async (uri) => {
        const resp = await fetch('/api/queue', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ uri })
        });
        if (!resp.ok) {
          const j = await resp.json().catch(() => ({}));
          throw new Error(j.error || 'Queue failed');
        }
      };

      const playPlaylist = async (playlistUri) => {
        const resp = await fetch('/api/playlist/shuffle', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ playlistUri })
        });
        if (!resp.ok) {
          const j = await resp.json().catch(() => ({}));
          throw new Error(j.error || 'Playlist playback failed');
        }
      };

      playlists.forEach(({ name, desc, cover, playlistUri }) => {
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <img class="playlist-cover" src="${cover}" alt="${name}">
          <div>
            <h3>${name}</h3>
            <p class="muted">${desc}</p>
          </div>
          <button class="btn btn--accent sparkle-btn" data-playlist="${playlistUri}">
            <span class="sparkle-label">Shuffle & play</span>
            <span class="sparkle-label" aria-hidden="true">Shuffle & play</span>
            <svg viewBox="0 0 96 96" xmlns="http://www.w3.org/2000/svg"><path d="M93.781 51.578C95 50.969 96 49.359 96 48c0-1.375-1-2.969-2.219-3.578 0 0-22.868-1.514-31.781-10.422-8.915-8.91-10.438-31.781-10.438-31.781C50.969 1 49.375 0 48 0s-2.969 1-3.594 2.219c0 0-1.5 22.87-10.406 31.781-8.908 8.913-31.781 10.422-31.781 10.422C1 45.031 0 46.625 0 48c0 1.359 1 2.969 2.219 3.578 0 0 22.873 1.51 31.781 10.422 8.906 8.911 10.406 31.781 10.406 31.781C45.031 95 46.625 96 48 96s2.969-1 3.562-2.219c0 0 1.523-22.871 10.438-31.781 8.913-8.908 31.781-10.422 31.781-10.422Z"/></svg>
            <svg viewBox="0 0 96 96" xmlns="http://www.w3.org/2000/svg"><path d="M93.781 51.578C95 50.969 96 49.359 96 48c0-1.375-1-2.969-2.219-3.578 0 0-22.868-1.514-31.781-10.422-8.915-8.91-10.438-31.781-10.438-31.781C50.969 1 49.375 0 48 0s-2.969 1-3.594 2.219c0 0-1.5 22.87-10.406 31.781-8.908 8.913-31.781 10.422-31.781 10.422C1 45.031 0 46.625 0 48c0 1.359 1 2.969 2.219 3.578 0 0 22.873 1.51 31.781 10.422 8.906 8.911 10.406 31.781 10.406 31.781C45.031 95 46.625 96 48 96s2.969-1 3.562-2.219c0 0 1.523-22.871 10.438-31.781 8.913-8.908 31.781-10.422 31.781-10.422Z"/></svg>
            <svg viewBox="0 0 96 96" xmlns="http://www.w3.org/2000/svg"><path d="M93.781 51.578C95 50.969 96 49.359 96 48c0-1.375-1-2.969-2.219-3.578 0 0-22.868-1.514-31.781-10.422-8.915-8.91-10.438-31.781-10.438-31.781C50.969 1 49.375 0 48 0s-2.969 1-3.594 2.219c0 0-1.5 22.87-10.406 31.781-8.908 8.913-31.781 10.422-31.781 10.422C1 45.031 0 46.625 0 48c0 1.359 1 2.969 2.219 3.578 0 0 22.873 1.51 31.781 10.422 8.906 8.911 10.406 31.781 10.406 31.781C45.031 95 46.625 96 48 96s2.969-1 3.562-2.219c0 0 1.523-22.871 10.438-31.781 8.913-8.908 31.781-10.422 31.781-10.422Z"/></svg>
            <svg viewBox="0 0 96 96" xmlns="http://www.w3.org/2000/svg"><path d="M93.781 51.578C95 50.969 96 49.359 96 48c0-1.375-1-2.969-2.219-3.578 0 0-22.868-1.514-31.781-10.422-8.915-8.91-10.438-31.781-10.438-31.781C50.969 1 49.375 0 48 0s-2.969 1-3.594 2.219c0 0-1.5 22.87-10.406 31.781-8.908 8.913-31.781 10.422-31.781 10.422C1 45.031 0 46.625 0 48c0 1.359 1 2.969 2.219 3.578 0 0 22.873 1.51 31.781 10.422 8.906 8.911 10.406 31.781 10.406 31.781C45.031 95 46.625 96 48 96s2.969-1 3.562-2.219c0 0 1.523-22.871 10.438-31.781 8.913-8.908 31.781-10.422 31.781-10.422Z"/></svg>
            <svg viewBox="0 0 96 96" xmlns="http://www.w3.org/2000/svg"><path d="M93.781 51.578C95 50.969 96 49.359 96 48c0-1.375-1-2.969-2.219-3.578 0 0-22.868-1.514-31.781-10.422-8.915-8.91-10.438-31.781-10.438-31.781C50.969 1 49.375 0 48 0s-2.969 1-3.594 2.219c0 0-1.5 22.87-10.406 31.781-8.908 8.913-31.781 10.422-31.781 10.422C1 45.031 0 46.625 0 48c0 1.359 1 2.969 2.219 3.578 0 0 22.873 1.51 31.781 10.422 8.906 8.911 10.406 31.781 10.406 31.781C45.031 95 46.625 96 48 96s2.969-1 3.562-2.219c0 0 1.523-22.871 10.438-31.781 8.913-8.908 31.781-10.422 31.781-10.422Z"/></svg>
          </button>
        `;
        playlistGrid.appendChild(card);
      });

      playlistGrid.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-playlist]');
        if (!btn) return;
        btn.disabled = true;
        try {
          await playPlaylist(btn.dataset.playlist);
          showToast('Playlist shuffled on your device');
          setTimeout(fetchNowPlaying, 1500);
        } catch (err) {
          showToast(err.message, '#f87171');
        } finally {
          btn.disabled = false;
        }
      });

      q.addEventListener('input', () => {
        clearTimeout(timer);
        const val = q.value.trim();
        if (!val) { ul.innerHTML = ''; return; }
        timer = setTimeout(async () => {
          try {
            const r = await fetch('/api/search?q=' + encodeURIComponent(val));
            const items = await r.json();
            ul.innerHTML = items.map(it =>
              `<li>
                <button class="result-btn" data-uri="${it.uri}">
                  <strong>${it.name}</strong><br>
                  <span class="muted">${it.artists}</span>
                </button>
              </li>`).join('');
          } catch (err) {
            showToast('Search failed', '#f87171');
          }
        }, 250);
      });

      ul.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-uri]');
        if (!btn) return;
        try {
          await queueTrack(btn.dataset.uri);
          showToast('Track added to queue');
        } catch (err) {
          showToast(err.message, '#f87171');
        }
      });

      const fetchNowPlaying = async () => {
        try {
          const resp = await fetch('/api/nowplaying');
          if (!resp.ok) throw new Error('Player unavailable');
          const data = await resp.json();
          if (!data.track) {
            trackEl.textContent = 'Nothing playing';
            progressEl.textContent = '';
            deviceEl.textContent = data.device ? `Device: ${data.device}` : 'No active device';
            artWrap.style.display = 'none';
            artEl.removeAttribute('src');
            vinylDisc.classList.remove('vinyl-disc--spinning');
            return;
          }
          trackEl.textContent = `${data.track.name} — ${data.track.artists}`;
          deviceEl.textContent = data.device ? `Device: ${data.device}` : 'Device unknown';
          const hasImage = Boolean(data.track.image);
          if (hasImage) {
            artEl.src = data.track.image;
            artEl.alt = `${data.track.name} cover art`;
            artWrap.style.display = 'block';
          } else {
            artWrap.style.display = 'none';
            artEl.removeAttribute('src');
          }
          vinylDisc.classList.toggle('vinyl-disc--spinning', data.isPlaying && hasImage);
          const mins = Math.floor((data.progressMs || 0) / 60000);
          const secs = Math.floor(((data.progressMs || 0) % 60000) / 1000).toString().padStart(2, '0');
          const durMins = Math.floor(data.track.durationMs / 60000);
          const durSecs = Math.floor((data.track.durationMs % 60000) / 1000).toString().padStart(2, '0');
          progressEl.textContent = `${mins}:${secs} / ${durMins}:${durSecs}`;
        } catch (err) {
          deviceEl.textContent = 'Need to login & start playback';
          trackEl.textContent = '—';
          progressEl.textContent = '';
        }
      };
      fetchNowPlaying();
      setInterval(fetchNowPlaying, 5000);

      const controlRoute = {
        play: '/api/player/play',
        pause: '/api/player/pause',
        next: '/api/player/next',
        previous: '/api/player/previous'
      };

      controlButtons.forEach(btn => {
        btn.addEventListener('click', async () => {
          const action = btn.dataset.control;
          btn.disabled = true;
          try {
            await fetch(controlRoute[action], { method: 'POST' });
            showToast(`${action} command sent`);
            setTimeout(fetchNowPlaying, 1000);
          } catch (err) {
            showToast('Failed to control player', '#f87171');
          } finally {
            btn.disabled = false;
          }
        });
      });

      document.addEventListener('pointermove', (event) => {
        const x = (event.clientX / window.innerWidth) * 100;
        const y = (event.clientY / window.innerHeight) * 100;
        document.body.style.setProperty('--glow-x', `${x}%`);
        document.body.style.setProperty('--glow-y', `${y}%`);
      });

      themeToggle.addEventListener('click', () => {
        const body = document.body;
        const isBlues = body.classList.toggle('theme-blues');
        if (isBlues) {
          body.classList.remove('theme-modern');
        } else {
          body.classList.add('theme-modern');
        }
        themeToggle.textContent = isBlues ? 'Switch to Modern' : 'Switch to Blues Bar';
      });
    </script>
  </body>
</html>
